services:
  
  zec-tst-db:
    image: postgres:15.5
    hostname: zecret-db.flycast
    shm_size: 512mb
    ports:
      - 5436:5432
    environment:
      PGDATA: /var/lib/pg_data
      POSTGRES_PASSWORD: password
      POSTGRES_HOST_AUTH_METHOD: trust
    volumes:
      - ./output/.pg-tst/data/pgdata:/var/lib/pg_data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - zecret-tst

  zec-tst-mg:
    build:
      context: ./services/migrations
      target: dev
    working_dir: $PWD/services/migrations
    user: node
    volumes:
      - $PWD/services/migrations:$PWD/services/migrations
    environment:
      - DATABASE_URL=postgres://postgres:password@zecret-db.flycast:5432/postgres
      - API_DATABASE_URL=postgres://api:password@zecret-db.flycast:5432/postgres
      - BOSS_DATABASE_URL=postgres://boss:password@zecret-db.flycast:5432/postgres
    depends_on:
      zec-tst-db:
        condition: service_healthy

    networks:
      - zecret-tst

  zec-tst-api:
    hostname: zecret-api.flycast
    build: ./services/server
    working_dir: $PWD/services/server
    user: node
    volumes:
      - $PWD/services/server:$PWD/services/server
    environment:
      API_DATABASE_URL: postgres://api:password@zecret-db.flycast:5432/postgres
      BOSS_DATABASE_URL: postgres://boss:password@zecret-db.flycast:5432/postgres
      ZECRET_API_TOKEN_SECRET: secret
      ZECRET_BASE_URL: http://localhost:8080
    env_file:
      - ./services/server/.env
    # keeps esbuild watch running
    tty: true
    # exit node from SIGINT
    init: true
    networks:
      - zecret-tst

    depends_on:
      zec-tst-mg: 
        condition: service_healthy

  zec-tst-tst:
    build: ./services/tests
    working_dir: $PWD/services/tests
    user: node
    volumes:
      - $PWD/services/tests:$PWD/services/tests
    environment:
      TEST_DATABASE_URL: postgres://postgres:password@zecret-db.flycast:5432/postgres
      BOSS_DATABASE_URL: postgres://boss:password@zecret-db.flycast:5432/postgres
      API_DATABASE_URL: postgres://api:password@zecret-db.flycast:5432/postgres
      ZECRET_API_URL: http://zecret-api.flycast:8080/api
      ZECRET_API_TOKEN_SECRET: secret
    # keeps esbuild watch running
    tty: true
    # exit node from SIGINT
    init: true
    networks:
      - zecret-tst

    depends_on:
      zec-tst-api: 
        condition: service_healthy

networks:
  zecret-tst:
